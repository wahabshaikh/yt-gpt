import Head from "next/head";
import { useEffect, useState } from "react";
import { toast } from "react-hot-toast";
import clsx from "clsx";
import Image from "next/image";
import Link from "next/link";
import { supabaseClient } from "~/lib/supabase";
import { useRouter } from "next/router";
import getYouTubeID from "get-youtube-id";

export default function Home() {
  const router = useRouter();

  const [url, setUrl] = useState("");
  const [recentVideos, setRecentVideos] = useState<
    { video_id: string; title: string; thumbnail: string; url: string }[]
  >([]);
  const [isLoading, setIsLoading] = useState(false);

  useEffect(() => {
    fetchRecentVideos();
  }, []);

  const fetchRecentVideos = async () => {
    const { data, error } = await supabaseClient
      .from("videos")
      .select("video_id, title, thumbnail, url")
      .limit(5);

    if (error) {
      toast.error(error.message);
      return;
    }

    if (!data || !data.length) {
      toast.error(`No videos found!`);
      return;
    }

    setRecentVideos(data);
  };

  const saveVideo = async (url: string) => {
    setIsLoading(true);

    try {
      await toast.promise(
        fetch("/api/save-video-details", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url }),
        }),
        {
          loading: "Fetching video details...",
          success: "Fetched video details successfully!",
          error: "Something went wrong while fetching video details!",
        }
      );

      await toast.promise(
        fetch("/api/save-video-summary", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url }),
        }),
        {
          loading: "Fetching video summary...",
          success: "Fetched video summary successfully!",
          error: "Something went wrong while fetching video summary!",
        }
      );

      const videoId = getYouTubeID(url, { fuzzy: false });

      router.push(`/videos/${videoId}`);
    } catch (error) {
      toast.error("Something went wrong!");
      console.error(error);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <main className="flex  flex-col items-center justify-center h-fit ">
      <Head>
        <title>YT-GPT</title>
      </Head>

      <Link href="/" className="mt-32">
        {/* <h3 className="landingHeading">Video GPT</h3> */}
        <svg
          width="329"
          height="113"
          viewBox="0 0 329 113"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M10.2869 58.8182L20.4822 90.8665H20.8736L31.0895 58.8182H40.9759L26.4347 101H14.9418L0.379972 58.8182H10.2869ZM41.5381 101V69.3636H50.3123V101H41.5381ZM45.9458 65.2855C44.6414 65.2855 43.5223 64.853 42.5886 63.9879C41.6686 63.1091 41.2086 62.0587 41.2086 60.8366C41.2086 59.6283 41.6686 58.5916 42.5886 57.7266C43.5223 56.8478 44.6414 56.4084 45.9458 56.4084C47.2503 56.4084 48.3625 56.8478 49.2825 57.7266C50.2162 58.5916 50.683 59.6283 50.683 60.8366C50.683 62.0587 50.2162 63.1091 49.2825 63.9879C48.3625 64.853 47.2503 65.2855 45.9458 65.2855ZM64.6485 101.515C62.2456 101.515 60.0692 100.897 58.1194 99.6612C56.1833 98.4117 54.6455 96.5786 53.5058 94.1619C52.3798 91.7315 51.8169 88.7519 51.8169 85.223C51.8169 81.598 52.4004 78.584 53.5676 76.1811C54.7347 73.7644 56.2863 71.9588 58.2224 70.7642C60.1722 69.5559 62.3074 68.9517 64.6279 68.9517C66.3993 68.9517 67.8753 69.2538 69.0562 69.858C70.2508 70.4484 71.212 71.1899 71.9397 72.0824C72.6812 72.9612 73.2442 73.8262 73.6287 74.6776H73.8964V58.8182H82.65V101H73.9994V95.9332H73.6287C73.2167 96.812 72.6332 97.6839 71.8779 98.549C71.1365 99.4003 70.1684 100.107 68.9738 100.67C67.793 101.233 66.3512 101.515 64.6485 101.515ZM67.4291 94.5327C68.8434 94.5327 70.038 94.1482 71.0129 93.3793C72.0015 92.5966 72.7567 91.505 73.2785 90.1044C73.814 88.7038 74.0818 87.063 74.0818 85.1818C74.0818 83.3007 73.8209 81.6667 73.2991 80.2798C72.7773 78.893 72.0221 77.822 71.0335 77.0668C70.0449 76.3116 68.8434 75.9339 67.4291 75.9339C65.9873 75.9339 64.7721 76.3253 63.7835 77.108C62.7949 77.8906 62.0465 78.9754 61.5385 80.3622C61.0304 81.7491 60.7764 83.3556 60.7764 85.1818C60.7764 87.0218 61.0304 88.6489 61.5385 90.0632C62.0602 91.4638 62.8086 92.5623 63.7835 93.3587C64.7721 94.1413 65.9873 94.5327 67.4291 94.5327ZM99.9315 101.618C96.6773 101.618 93.8761 100.959 91.5281 99.6406C89.1938 98.3087 87.3951 96.4276 86.1318 93.9972C84.8686 91.553 84.2369 88.6626 84.2369 85.326C84.2369 82.0717 84.8686 79.2157 86.1318 76.7578C87.3951 74.3 89.1732 72.3845 91.4663 71.0114C93.7732 69.6383 96.4782 68.9517 99.5814 68.9517C101.669 68.9517 103.611 69.2881 105.41 69.9609C107.223 70.62 108.802 71.6155 110.147 72.9474C111.507 74.2794 112.564 75.9545 113.319 77.973C114.075 79.9777 114.452 82.3258 114.452 85.017V87.4268H87.7383V81.9893H106.193C106.193 80.7261 105.918 79.607 105.369 78.6321C104.82 77.6572 104.058 76.8951 103.083 76.3459C102.122 75.7829 101.003 75.5014 99.7256 75.5014C98.3937 75.5014 97.2128 75.8104 96.183 76.4283C95.1669 77.0324 94.3705 77.8494 93.7937 78.8793C93.217 79.8954 92.9218 81.0282 92.9081 82.2777V87.4474C92.9081 89.0128 93.1964 90.3653 93.7732 91.505C94.3636 92.6446 95.1943 93.5234 96.2653 94.1413C97.3364 94.7592 98.6065 95.0682 100.076 95.0682C101.051 95.0682 101.943 94.9309 102.753 94.6562C103.563 94.3816 104.257 93.9697 104.834 93.4205C105.41 92.8712 105.85 92.1984 106.152 91.402L114.267 91.9375C113.855 93.8873 113.01 95.59 111.733 97.0455C110.47 98.4872 108.836 99.6132 106.831 100.423C104.84 101.22 102.54 101.618 99.9315 101.618ZM130.122 101.618C126.923 101.618 124.156 100.938 121.822 99.5788C119.501 98.2057 117.709 96.2971 116.446 93.853C115.183 91.3951 114.551 88.5459 114.551 85.3054C114.551 82.0374 115.183 79.1813 116.446 76.7372C117.709 74.2794 119.501 72.3707 121.822 71.0114C124.156 69.6383 126.923 68.9517 130.122 68.9517C133.321 68.9517 136.081 69.6383 138.402 71.0114C140.736 72.3707 142.535 74.2794 143.798 76.7372C145.061 79.1813 145.693 82.0374 145.693 85.3054C145.693 88.5459 145.061 91.3951 143.798 93.853C142.535 96.2971 140.736 98.2057 138.402 99.5788C136.081 100.938 133.321 101.618 130.122 101.618ZM130.163 94.821C131.619 94.821 132.834 94.4091 133.809 93.5852C134.784 92.7476 135.518 91.608 136.013 90.1662C136.521 88.7244 136.775 87.0836 136.775 85.2436C136.775 83.4036 136.521 81.7628 136.013 80.321C135.518 78.8793 134.784 77.7396 133.809 76.902C132.834 76.0644 131.619 75.6456 130.163 75.6456C128.694 75.6456 127.458 76.0644 126.456 76.902C125.467 77.7396 124.719 78.8793 124.211 80.321C123.716 81.7628 123.469 83.4036 123.469 85.2436C123.469 87.0836 123.716 88.7244 124.211 90.1662C124.719 91.608 125.467 92.7476 126.456 93.5852C127.458 94.4091 128.694 94.821 130.163 94.821ZM147.048 69.3636H155.822V102.565C155.822 105.009 155.342 106.987 154.381 108.497C153.42 110.008 152.04 111.113 150.241 111.813C148.456 112.513 146.321 112.864 143.835 112.864C143.533 112.864 143.245 112.857 142.97 112.843C142.682 112.843 142.38 112.836 142.064 112.822V105.964C142.297 105.978 142.503 105.984 142.682 105.984C142.847 105.998 143.025 106.005 143.217 106.005C144.632 106.005 145.62 105.703 146.183 105.099C146.76 104.508 147.048 103.616 147.048 102.421V69.3636ZM151.415 65.2855C150.124 65.2855 149.012 64.853 148.078 63.9879C147.144 63.1091 146.678 62.0587 146.678 60.8366C146.678 59.6283 147.144 58.5916 148.078 57.7266C149.012 56.8478 150.124 56.4084 151.415 56.4084C152.733 56.4084 153.852 56.8478 154.772 57.7266C155.706 58.5916 156.173 59.6283 156.173 60.8366C156.173 62.0587 155.706 63.1091 154.772 63.9879C153.852 64.853 152.733 65.2855 151.415 65.2855ZM167.522 101.597C165.504 101.597 163.705 101.247 162.126 100.547C160.547 99.8329 159.297 98.7824 158.377 97.3956C157.471 95.995 157.018 94.2512 157.018 92.1641C157.018 90.4065 157.341 88.9304 157.986 87.7358C158.631 86.5412 159.51 85.58 160.622 84.8523C161.735 84.1245 162.998 83.5753 164.412 83.2045C165.84 82.8338 167.337 82.5729 168.902 82.4219C170.742 82.2296 172.225 82.0511 173.351 81.8864C174.477 81.7079 175.294 81.447 175.802 81.1037C176.31 80.7604 176.564 80.2524 176.564 79.5795V79.456C176.564 78.1515 176.152 77.1423 175.328 76.4283C174.518 75.7143 173.365 75.3572 171.868 75.3572C170.289 75.3572 169.033 75.7074 168.099 76.4077C167.165 77.0942 166.547 77.9593 166.245 79.0028L158.13 78.3438C158.542 76.4214 159.352 74.7599 160.561 73.3594C161.769 71.9451 163.327 70.8603 165.236 70.1051C167.158 69.3362 169.383 68.9517 171.909 68.9517C173.667 68.9517 175.349 69.1577 176.956 69.5696C178.576 69.9815 180.011 70.62 181.26 71.4851C182.524 72.3501 183.519 73.4624 184.247 74.8217C184.975 76.1674 185.338 77.7808 185.338 79.6619V101H177.017V96.6129H176.77C176.262 97.6016 175.582 98.4735 174.731 99.2287C173.88 99.9702 172.857 100.554 171.662 100.979C170.468 101.391 169.088 101.597 167.522 101.597ZM170.035 95.5419C171.326 95.5419 172.466 95.2879 173.454 94.7798C174.443 94.258 175.219 93.5578 175.782 92.679C176.345 91.8002 176.626 90.8047 176.626 89.6925V86.3352C176.351 86.5137 175.974 86.6785 175.493 86.8295C175.026 86.9669 174.498 87.0973 173.907 87.2209C173.317 87.3307 172.726 87.4337 172.136 87.5298C171.546 87.6122 171.01 87.6877 170.529 87.7564C169.5 87.9074 168.6 88.1477 167.831 88.4773C167.062 88.8068 166.465 89.2531 166.039 89.8161C165.614 90.3653 165.401 91.0518 165.401 91.8757C165.401 93.0703 165.833 93.9834 166.698 94.6151C167.577 95.233 168.689 95.5419 170.035 95.5419ZM187.796 101V69.3636H196.302V74.8835H196.632C197.208 72.92 198.176 71.437 199.536 70.4347C200.895 69.4186 202.46 68.9105 204.232 68.9105C204.671 68.9105 205.145 68.938 205.653 68.9929C206.161 69.0478 206.607 69.1233 206.992 69.2195V77.005C206.58 76.8814 206.01 76.7715 205.282 76.6754C204.554 76.5793 203.888 76.5312 203.284 76.5312C201.993 76.5312 200.84 76.8127 199.824 77.3757C198.822 77.925 198.025 78.6939 197.435 79.6825C196.858 80.6712 196.57 81.8108 196.57 83.1016V101H187.796ZM237.635 69.3636L226.575 101H216.688L205.628 69.3636H214.897L221.467 91.9993H221.796L228.346 69.3636H237.635ZM237.775 101V69.3636H246.549V101H237.775ZM242.183 65.2855C240.878 65.2855 239.759 64.853 238.826 63.9879C237.906 63.1091 237.446 62.0587 237.446 60.8366C237.446 59.6283 237.906 58.5916 238.826 57.7266C239.759 56.8478 240.878 56.4084 242.183 56.4084C243.487 56.4084 244.6 56.8478 245.52 57.7266C246.453 58.5916 246.92 59.6283 246.92 60.8366C246.92 62.0587 246.453 63.1091 245.52 63.9879C244.6 64.853 243.487 65.2855 242.183 65.2855ZM275.55 78.3849L267.518 78.8793C267.38 78.1927 267.085 77.5748 266.632 77.0256C266.179 76.4626 265.582 76.0163 264.84 75.6868C264.112 75.3435 263.241 75.1719 262.224 75.1719C260.865 75.1719 259.719 75.4602 258.785 76.0369C257.851 76.5999 257.384 77.3551 257.384 78.3026C257.384 79.0578 257.686 79.6963 258.29 80.218C258.895 80.7398 259.931 81.1586 261.401 81.4744L267.126 82.6278C270.202 83.2595 272.495 84.2756 274.006 85.6761C275.516 87.0767 276.271 88.9167 276.271 91.196C276.271 93.2694 275.66 95.0888 274.438 96.6541C273.23 98.2195 271.568 99.4415 269.454 100.32C267.353 101.185 264.929 101.618 262.183 101.618C257.995 101.618 254.659 100.746 252.173 99.0021C249.702 97.2446 248.253 94.8554 247.827 91.8345L256.457 91.3814C256.718 92.6584 257.35 93.6333 258.352 94.3061C259.355 94.9652 260.638 95.2947 262.204 95.2947C263.742 95.2947 264.978 94.9995 265.911 94.4091C266.859 93.8049 267.339 93.0291 267.353 92.0817C267.339 91.2853 267.003 90.633 266.344 90.125C265.685 89.6032 264.669 89.205 263.295 88.9304L257.817 87.8388C254.727 87.2209 252.427 86.1499 250.917 84.6257C249.42 83.1016 248.672 81.1586 248.672 78.7969C248.672 76.7647 249.221 75.014 250.32 73.5447C251.432 72.0755 252.99 70.9427 254.995 70.1463C257.013 69.3499 259.375 68.9517 262.08 68.9517C266.076 68.9517 269.22 69.7962 271.513 71.4851C273.82 73.174 275.166 75.474 275.55 78.3849ZM282.575 101.536C281.216 101.536 280.048 101.055 279.073 100.094C278.112 99.1188 277.632 97.9517 277.632 96.5923C277.632 95.2467 278.112 94.0933 279.073 93.1321C280.048 92.1709 281.216 91.6903 282.575 91.6903C283.893 91.6903 285.046 92.1709 286.035 93.1321C287.024 94.0933 287.518 95.2467 287.518 96.5923C287.518 97.4986 287.285 98.3293 286.818 99.0845C286.365 99.826 285.767 100.423 285.026 100.876C284.284 101.316 283.467 101.536 282.575 101.536ZM299.393 101.597C297.375 101.597 295.576 101.247 293.997 100.547C292.418 99.8329 291.168 98.7824 290.248 97.3956C289.342 95.995 288.889 94.2512 288.889 92.1641C288.889 90.4065 289.211 88.9304 289.857 87.7358C290.502 86.5412 291.381 85.58 292.493 84.8523C293.605 84.1245 294.869 83.5753 296.283 83.2045C297.711 82.8338 299.208 82.5729 300.773 82.4219C302.613 82.2296 304.096 82.0511 305.222 81.8864C306.348 81.7079 307.165 81.447 307.673 81.1037C308.181 80.7604 308.435 80.2524 308.435 79.5795V79.456C308.435 78.1515 308.023 77.1423 307.199 76.4283C306.389 75.7143 305.236 75.3572 303.739 75.3572C302.16 75.3572 300.903 75.7074 299.97 76.4077C299.036 77.0942 298.418 77.9593 298.116 79.0028L290.001 78.3438C290.413 76.4214 291.223 74.7599 292.431 73.3594C293.64 71.9451 295.198 70.8603 297.107 70.1051C299.029 69.3362 301.254 68.9517 303.78 68.9517C305.538 68.9517 307.22 69.1577 308.826 69.5696C310.447 69.9815 311.881 70.62 313.131 71.4851C314.394 72.3501 315.39 73.4624 316.117 74.8217C316.845 76.1674 317.209 77.7808 317.209 79.6619V101H308.888V96.6129H308.641C308.133 97.6016 307.453 98.4735 306.602 99.2287C305.751 99.9702 304.728 100.554 303.533 100.979C302.338 101.391 300.958 101.597 299.393 101.597ZM301.906 95.5419C303.197 95.5419 304.336 95.2879 305.325 94.7798C306.313 94.258 307.089 93.5578 307.652 92.679C308.215 91.8002 308.497 90.8047 308.497 89.6925V86.3352C308.222 86.5137 307.844 86.6785 307.364 86.8295C306.897 86.9669 306.368 87.0973 305.778 87.2209C305.188 87.3307 304.597 87.4337 304.007 87.5298C303.416 87.6122 302.881 87.6877 302.4 87.7564C301.37 87.9074 300.471 88.1477 299.702 88.4773C298.933 88.8068 298.336 89.2531 297.91 89.8161C297.484 90.3653 297.272 91.0518 297.272 91.8757C297.272 93.0703 297.704 93.9834 298.569 94.6151C299.448 95.233 300.56 95.5419 301.906 95.5419ZM319.666 101V69.3636H328.44V101H319.666ZM324.074 65.2855C322.769 65.2855 321.65 64.853 320.717 63.9879C319.797 63.1091 319.337 62.0587 319.337 60.8366C319.337 59.6283 319.797 58.5916 320.717 57.7266C321.65 56.8478 322.769 56.4084 324.074 56.4084C325.378 56.4084 326.491 56.8478 327.411 57.7266C328.344 58.5916 328.811 59.6283 328.811 60.8366C328.811 62.0587 328.344 63.1091 327.411 63.9879C326.491 64.853 325.378 65.2855 324.074 65.2855Z"
            fill="#464646"
          />
          <path
            d="M176.2 32L189.4 32.7L181 22.3L201 23.3L196.9 18.2C194.1 14.7 189.9 12.5999 185.5 12.3999L172.3 11.7L180.7 22.0999L160.7 21.0999L164.8 26.2C167.6 29.6 171.7 31.7 176.2 32Z"
            fill="#464646"
          />
          <path
            d="M147.5 20.3L160.7 21L152.3 10.6L172.3 11.6L168.2 6.5C165.4 3 161.2 0.899997 156.8 0.699997L143.6 0L152 10.4L132 9.39999L136.1 14.5C138.9 18 143.1 20.1 147.5 20.3Z"
            fill="#464646"
          />
        </svg>

        {/* <Image src="/logo.png" alt="YT-GPT" height={120} width={120} /> */}
      </Link>

      <form
        className="mt-8 max-w-4xl w-full"
        onSubmit={(e) => {
          e.preventDefault();

          if (url) {
            saveVideo(url);
          } else {
            toast.error("Please provide a url!");
          }
        }}
      >
        <div className="form-control">
          <div className="text-center">
            <p className="landingIntro ">
              Connect with your favorite YouTube videos. Paste the URL below to
              start chatting
            </p>
            {/* <label className="label">
            <span className="label-text">Enter the YouTube Video URL</span>
          </label> */}
          </div>

          <div className="input-group">
            <input
              type="url"
              className="input input-bordered w-full"
              placeholder="https://www.youtube.com/watch?v="
              value={url}
              onChange={(e) => setUrl(e.target.value)}
              required
            />
            <button
              type="submit"
              className={clsx("btn btn-square", isLoading && "loading")}
              disabled={isLoading}
            >
              {!isLoading && (
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  className="w-6 h-6"
                >
                  <path
                    fillRule="evenodd"
                    d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z"
                    clipRule="evenodd"
                  />
                </svg>
              )}
            </button>
          </div>
        </div>
      </form>

      {/* <section className="mt-8">
        <h2 className="text-3xl font-bold">Recent Videos</h2>
        <ul className="mt-8 space-y-4">
          {recentVideos.map((video) => (
            <li key={video.video_id}>
              <Link href={`/videos/${video.video_id}`}>
                <div className="flex gap-4 items-center">
                  <Image
                    src={video.thumbnail}
                    alt={video.title}
                    height={120}
                    width={120}
                  />
                  <div>
                    <h3 className="font-bold">{video.title}</h3>
                    <a href={video.url} target="_blank" className="link">
                      Watch Video
                    </a>
                  </div>
                </div>
              </Link>
            </li>
          ))}
        </ul>
      </section> */}
      <footer className="footer">
        <svg
          width="24"
          height="20"
          viewBox="0 0 24 20"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M23 1.01006C22.0424 1.68553 20.9821 2.20217 19.86 2.54006C19.2577 1.84757 18.4573 1.35675 17.567 1.13398C16.6767 0.911216 15.7395 0.967251 14.8821 1.29451C14.0247 1.62177 13.2884 2.20446 12.773 2.96377C12.2575 3.72309 11.9877 4.62239 12 5.54006V6.54006C10.2426 6.58562 8.50127 6.19587 6.93101 5.4055C5.36074 4.61513 4.01032 3.44869 3 2.01006C3 2.01006 -1 11.0101 8 15.0101C5.94053 16.408 3.48716 17.109 1 17.0101C10 22.0101 21 17.0101 21 5.51006C20.9991 5.23151 20.9723 4.95365 20.92 4.68006C21.9406 3.67355 22.6608 2.40277 23 1.01006Z"
            fill="#334155"
            stroke="#334155"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </footer>
    </main>
  );
}
